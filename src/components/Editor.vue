<template>
  <v-container fluid>
    <v-row>
      <!-- Left Column: Chat and Model Selector -->
      <v-col cols="6">

        <!-- Model Selector -->
        <v-select
          v-model="selectedModel"
          :items="modelStore.models"
          item-title="model"
          item-value="model"
          label="Select Model"
          variant="outlined"
          density="compact"
        >
          <template v-slot:item="{ props, item }">
            <v-list-item v-bind="props">
              <v-list-item-subtitle>
                {{ item.raw.details.parameter_size }} |
                {{ (item.raw.size / (1024 * 1024 * 1024)).toFixed(2) }} GB
              </v-list-item-subtitle>
            </v-list-item>
          </template>
        </v-select>

        <!-- Show Chat if Initialized -->
        <div v-if="!selectedModel" class="chat-area">
          <p>Please select a model to start the chat.</p>
        </div>
        <div v-else>
          <Chat :chatId="chatId"/>
        </div>

        <!-- Message Input -->
        <v-row class="mt-3">
          <v-col cols="10">
            <v-textarea
              label="Send message to LLM"
              v-model="userMessage"
              variant="outlined"
              density="compact"
              @keydown.enter="sendChat"
              :disabled="chatId === 'unknown' || !selectedModel"
            ></v-textarea>
          </v-col>
          <v-col cols="2">
            <v-btn variant="flat" color="primary" @click="sendChat" :disabled="chatId === 'unknown' || !selectedModel">
              Send
            </v-btn>
          </v-col>
        </v-row>
      </v-col>

      <!-- Right Column: Iframe Preview and Version Control -->
      <v-col cols="6">
        <h3>Code Output</h3>
        <iframe class="code-preview" :srcdoc="iframeContent"/>

        <!-- Versioning Controls -->
        <div class="version-controls mt-3">
          <h4>Versions</h4>
          <v-btn v-for="version in iframeStore.getVersionCount" :key="version" @click="switchVersion(version)">
            Version {{ version + 1 }}
          </v-btn>
        </div>
      </v-col>
    </v-row>
  </v-container>
</template>

<script setup lang="ts">
import { ref, computed, watch } from 'vue';
import { useModelStore } from '@/stores/models';
import { useChatStore } from '@/stores/chats';
import { useIframeStore } from '@/stores/iframeStore'; // New store for iframe content
import Chat from '@/components/chat.vue';

// Stores for models, chats, and iframe content
const modelStore = useModelStore();
const chatStore = useChatStore();
const iframeStore = useIframeStore();

// Refs for the selected model, chat, and messages
const selectedModel = ref(null);
const chatId = ref('unknown');  // Define a unique ID for the playground chat
const userMessage = ref('');

// Get the iframe content generated by the store
const iframeContent = computed(() => iframeStore.getIframeContent);

// Watch for when the model is selected and create the chat
watch(selectedModel, (newModel) => {
  if (newModel) {
    chatId.value = chatStore.createChat({
      model: newModel,  // Use the selected model
      temperature: 0.3,
      systemPrompt: `**You are an advanced coding assistant specializing in HTML, CSS, and JavaScript. Your role is to help the user build, modify, and explain web content.**

**Capabilities and Guidelines:**
- **Reasoning**: Before making significant changes or updating the iframe, first explain your thought process or provide intermediate steps. If you need to clarify the task or verify your reasoning, use reasoning steps to help guide the user through your approach.
- **Tool Usage**: When you are certain of the changes, use the tool \`update_iframe_code\` to update the content of the iframe with HTML, CSS, and JavaScript. Ensure that the code you produce is well-structured and directly updates the iframe to reflect changes immediately.

**Important Notes**:
- **Reasoning before Action**: Always prioritize reasoning and clarification over making immediate changes. Use multiple reasoning steps if necessary before updating the iframe.
- **Code Explanation**: In normal chat messages, explain the logic behind your code and ensure the user understands the changes you are making.
- **Efficient and Concise**: Keep explanations and code concise, but always make sure the user understands what is happening before proceeding to the next step.`
    });
  }
});

// Send a chat message to the LLM and handle tool calls
async function sendChat() {
  if (!userMessage.value.trim()) return;

  // Call the handleToolCalls method from the chat store
  await chatStore.handleIframeTool(chatId.value, userMessage.value);

  // Clear the input after sending
  userMessage.value = '';
}

// Handle version switching
function switchVersion(version: number) {
  iframeStore.switchVersion(version);
}
</script>

<style scoped>
.chat-area {
  max-height: 500px;
  overflow-y: auto;
  border: 1px solid #ccc;
  padding: 10px;
  background-color: #f9f9f9;
}

.code-preview {
  width: 100%;
  height: 500px;
  border: 1px solid #ccc;
}

.version-controls {
  display: flex;
  gap: 10px;
}
</style>
