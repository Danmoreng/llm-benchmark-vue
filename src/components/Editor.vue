<template>
  <v-container fluid class="editor-container">
    <v-row class="editor-row">
      <!-- Left Column: Chat and Model Selector -->
      <v-col cols="6" class="editor-col">
        <!-- Model Selector -->
        <v-select
          v-model="selectedModel"
          :items="modelStore.models"
          item-title="model"
          item-value="model"
          label="Select Model"
          variant="outlined"
          density="compact"
        >
          <template v-slot:item="{ props, item }">
            <v-list-item v-bind="props">
              <v-list-item-subtitle>
                {{ item.raw.details.parameter_size }} |
                {{ (item.raw.size / (1024 * 1024 * 1024)).toFixed(2) }} GB
              </v-list-item-subtitle>
            </v-list-item>
          </template>
        </v-select>

        <!-- Show Chat if Initialized -->
        <div v-if="!selectedModel" class="chat-area no-chat">
          <p>Please select a model to start the chat.</p>
        </div>
        <div v-else class="chat-area">
          <Chat :chatId="chatId" />
        </div>

        <!-- Message Input -->
        <v-row class="mt-3">
          <v-col cols="10">
            <v-textarea
              label="Send message to LLM"
              v-model="userMessage"
              variant="outlined"
              density="compact"
              @keydown.enter="sendChat"
              :disabled="chatId === 'unknown' || !selectedModel"
            ></v-textarea>
          </v-col>
          <v-col cols="2">
            <v-btn variant="flat" color="primary" @click="sendChat" :disabled="chatId === 'unknown' || !selectedModel">
              Send
            </v-btn>
          </v-col>
        </v-row>
      </v-col>

      <!-- Right Column: Iframe Preview and Version Control -->
      <v-col cols="6" class="editor-col">
        <iframe class="code-preview" :srcdoc="iframeContent"/>

        <!-- Versioning Controls -->
        <div class="version-controls mt-3">
          <v-btn variant="text" size="compact" v-for="version in iframeStore.getVersionCount" :key="version" @click="switchVersion(version)">
            Version {{ version + 1 }}
          </v-btn>
        </div>
      </v-col>
    </v-row>
  </v-container>
</template>

<script setup lang="ts">
import { ref, computed, watch } from 'vue';
import { useModelStore } from '@/stores/models';
import { useChatStore } from '@/stores/chats';
import { useIframeStore } from '@/stores/iframeStore'; // New store for iframe content
import Chat from '@/components/chat.vue';

// Stores for models, chats, and iframe content
const modelStore = useModelStore();
const chatStore = useChatStore();
const iframeStore = useIframeStore();

// Refs for the selected model, chat, and messages
const selectedModel = ref(null);
const chatId = ref('unknown');  // Define a unique ID for the playground chat
const userMessage = ref('');

// Get the iframe content generated by the store
const iframeContent = computed(() => iframeStore.getIframeContent);

// Watch for when the model is selected and create the chat
watch(selectedModel, (newModel) => {
  if (newModel) {
    chatId.value = chatStore.createChat({
      model: newModel,  // Use the selected model
      temperature: 0.3,
      systemPrompt: `**You are an advanced coding assistant specializing in HTML, CSS, and JavaScript. Your role is to help the user build, modify, and enhance web content. You should always prioritize taking action by updating the iframe content directly before explaining or asking questions.**

**Capabilities and Tools Available**:
- **Reasoning Step (reasoning_step)**: Use the \`reasoning_step\` tool only when clarification is needed before performing an update, or when you're unsure about how to proceed. Minimize unnecessary reasoning steps unless absolutely required.
- **Update HTML (update_html)**: Automatically use the \`update_html\` tool to modify the HTML content inside the iframe whenever HTML needs to be updated.
- **Update CSS (update_css)**: Automatically use the \`update_css\` tool to update CSS styles in the iframe. Ensure changes are made efficiently.
- **Update JavaScript (update_js)**: Automatically use the \`update_js\` tool to update or add JavaScript functionality inside the iframe. Always ensure that the JavaScript is functional and properly integrated.
- **Update Full Iframe Content (update_all)**: Use the \`update_all\` tool to update the entire iframe content (HTML, CSS, and JavaScript) when all three need to be modified at once.

**Guidelines for Behavior**:
- **Prioritize Tool Usage**: Always use the appropriate tool first to perform the requested update before responding to the user. Once the update is complete, briefly explain what you’ve done.
- **Automatic Updates**: If the user’s message implies that a code update is needed, determine the correct tool to use and update the iframe content automatically. Do not wait for explicit instructions from the user.
- **Concise Explanations After Action**: Provide concise explanations of the updates after performing the action. Focus on what you’ve changed rather than on lengthy reasoning.
- **Minimal Clarification**: Only use reasoning or ask clarifying questions if absolutely necessary. If the task is clear, prioritize action by using the tools first.
- **Efficient Code and Best Practices**: Ensure that all code updates are efficient, error-free, and follow best practices in HTML, CSS, and JavaScript. Handle any potential errors in JavaScript code updates.

**Workflow**:
1. **Understand the User’s Request**: Immediately identify whether the user’s message requires an update to the iframe content (HTML, CSS, or JavaScript).
2. **Perform the Update**: Use the appropriate tool to make the necessary updates to the iframe content without waiting for explicit instructions.
3. **Provide a Brief Explanation**: After performing the update, provide a concise explanation of the change. Avoid overly detailed explanations unless the user asks for more clarification.
4. **Final Confirmation**: After each update, confirm with the user if the change meets their expectations and make adjustments if necessary.

Your primary goal is to assist the user by directly updating the iframe and then explaining the changes. Always focus on action first and explanation second.`
    });
  }
});

// Send a chat message to the LLM and handle tool calls
async function sendChat() {
  if (!userMessage.value.trim()) return;

  // Call the handleToolCalls method from the chat store
  await chatStore.sendChatMessage(chatId.value, userMessage.value);

  // Clear the input after sending
  userMessage.value = '';
}

// Handle version switching
function switchVersion(version: number) {
  iframeStore.switchVersion(version);
}
</script>

<style scoped>
.editor-container {
  height: 100%; /* Take up the available height */
}

.editor-row {
  height: 100%;
}

.editor-col {
  display: flex;
  flex-direction: column;
  height: 100%;
}

.chat-area {
  flex-grow: 1;
  overflow-y: auto;
  border: 1px solid #ccc;
  padding: 10px;
  background-color: #f9f9f9;
}

.no-chat {
  display: flex;
  justify-content: center;
  align-items: center;
  height: 100%;
}

.code-preview {
  width: 100%;
  height: 100%;
  border: 1px solid #ccc;
}

.version-controls {
  display: flex;
  gap: 10px;
  margin-top: 10px;
}
</style>
